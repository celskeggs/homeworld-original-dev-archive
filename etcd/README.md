# How to use this?

Create a cluster-config.conf:

	# this name doesn't matter too much, but should be unique
	cluster hyades-cluster-N

	node master01 HOSTNAME.mit.edu 18.181.NN.NN
	node master02 HOSTNAME.mit.edu 18.181.NN.NN
	node master03 HOSTNAME.mit.edu 18.181.NN.NN

Use an odd number of nodes, preferably.

Run build-cluster.py on:
  - the configuration file
  - a directory for the intermediate built cluster info
  - a secrets directory for the built cluster
  - the directory containing the ca.pem and ca-key.pem files for the etcd
    certificate authority

This will generate a folder of intermediate cluster info, which contains a
bunch of configuration files and two scripts.

One script is generate-secrets.sh, which will create private keys for each of
the etcd nodes and get signed certificates from the CA for each of them. These
are all put in the secrets directory.

After generate-secrets.sh, the next script is deploy.sh, which will deploy rkt,
etcd, the relevant configuration, and the ssl certificates. The cluster should
now come online.


# How does this work?

An overview:

The generated scripts shell out to generate-cert.sh and deploy-etcd.sh.

generate-cert sets up relevant configuration, generates a private key, creates
a certificate signing request, and then approves that request with the CA's
private key.

deploy-etcd alternates between copying files and running commands. It does the
following:

 * Upload rkt (the container system) debian package and install it.
 * Upload and trust the coreos signing key.
 * Make relevant directories exist.
 * Upload launch-etcd.sh (see below) and etcd.service (see below) as extra etcd
   launching infrastructure.
 * Upload the configuration file generated by build-cluster.py.
 * Upload certificate authority public keys.
 * Upload certificate and private key for this node.
 * Start and enable the previously-uploaded systemd unit for etcd.

etcd.service is a pretty straightforward systemd unit, with some minor tweaks
(Slice=machine.slice, KillMode=mixed) that come recommended from the rkt guide.
It just starts launch-etcd.sh.

launch-etcd.sh does the heavy lifting of start etcd. It builds the set of
options for rkt and etcd:

 * Provide a persistent data directory for etcd.
 * Provide access to the host directory providing TLS secrets and info to the
   etcd container.
 * Redirect public ports (2379, 2380) to ports on the container.
 * Configure etcd node name, advertisement URLs, and listening URLs.
 * Provide an initial cluster state for the etcd nodes, so that they all know
   each other and can build a cluster properly.
 * Tell etcd about the private keys and trusted certificates, and require
   TLS authentication.

And then launches the container with rkt run on the ACI.
